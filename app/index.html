<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' ws: blob:; style-src 'self' 'unsafe-inline';">
    <title>Electron P2P Voice Chat</title>
    
    <link rel="stylesheet" href="main.css">
</head>
<body>

<div class="container">
    <h1>ðŸ”Š P2P Sesli Sohbet</h1>
    <div id="status">HazÄ±r...</div>
    
    <div class="input-group">
        <input type="text" id="username" placeholder="KullanÄ±cÄ± AdÄ±nÄ±z" value="User">
    </div>
    
    <div class="controls">
        <button id="btnConnect">Sohbete KatÄ±l</button>
        <div class="audio-controls" id="audioControls">
            <button id="btnToggleMic">ðŸŽ¤ Mikrofon AÃ§Ä±k</button>
            <button id="btnToggleSound">ðŸ”Š Ses Duyuluyor</button>
        </div>
    </div>
    
    <div id="error-log"></div>

    <div id="users">
        <h3 style="border-bottom: 1px solid #eee; padding-bottom: 10px;">BaÄŸlÄ± KullanÄ±cÄ±lar</h3>
        <div id="userList"></div>
    </div>
</div>

<div id="audioContainer"></div>

<script>
    // --- BAÅžLANGIÃ‡ KONTROLÃœ ---
    window.onload = () => {
        if (window.SimplePeer) console.log("âœ… Sistem HazÄ±r");
        else document.getElementById('error-log').innerText = "HATA: SimplePeer yÃ¼klenemedi.";
    };

    const PORT = 8080;
    const WS_URL = `wss://unraspy-intramural-marshall.ngrok-free.dev`;    
    let socket;
    let localStream;
    let peers = {}; 
    let userNames = {}; // Ä°simleri tutmak iÃ§in
    let isMicMuted = false;
    let isDeafened = false;

    const inputUsername = document.getElementById('username');
    const statusDiv = document.getElementById('status');
    const userListDiv = document.getElementById('userList');
    const btnConnect = document.getElementById('btnConnect');
    const btnToggleMic = document.getElementById('btnToggleMic');
    const btnToggleSound = document.getElementById('btnToggleSound');
    const audioControls = document.getElementById('audioControls');

    inputUsername.value += "_" + Math.floor(Math.random() * 1000);

    // --- BUTON: BAÄžLAN ---
    btnConnect.addEventListener('click', async () => {
        const name = inputUsername.value;
        btnConnect.disabled = true;
        inputUsername.disabled = true;
        
        statusDiv.innerText = "Mikrofon izni alÄ±nÄ±yor...";
        try {
            localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
            statusDiv.innerText = "Sunucuya baÄŸlanÄ±lÄ±yor...";
            
            btnConnect.style.display = 'none';
            audioControls.style.display = 'flex';
            
            userNames["me"] = name + " (Ben)";
            addUserUI("me", userNames["me"], true);
            attachVisualizer(localStream, "me");

            connectSocket(name);
        } catch (err) {
            console.error(err);
            statusDiv.innerText = "HATA: Mikrofon izni verilmedi!";
            btnConnect.disabled = false;
        }
    });

    // --- SES KONTROLLERÄ° ---
    function setMicState(mute) {
        if (!localStream) return;
        const track = localStream.getAudioTracks()[0];
        isMicMuted = mute;
        track.enabled = !mute;

        if (isMicMuted) {
            btnToggleMic.innerText = "ðŸ”‡ Mikrofon KapalÄ±";
            btnToggleMic.style.backgroundColor = "#ff4757";
            const bar = document.getElementById('meter-fill-me');
            if(bar) bar.style.backgroundColor = "#ccc";
        } else {
            btnToggleMic.innerText = "ðŸŽ¤ Mikrofon AÃ§Ä±k";
            btnToggleMic.style.backgroundColor = "#2ecc71";
            const bar = document.getElementById('meter-fill-me');
            if(bar) bar.style.backgroundColor = "#2ecc71";
        }
    }

    btnToggleMic.addEventListener('click', () => {
        if (isDeafened) return alert("HoparlÃ¶r kapalÄ±yken mikrofonu aÃ§amazsÄ±nÄ±z!");
        setMicState(!isMicMuted);
    });

    btnToggleSound.addEventListener('click', () => {
        isDeafened = !isDeafened;
        document.querySelectorAll('audio').forEach(audio => audio.muted = isDeafened);

        if (isDeafened) {
            btnToggleSound.innerText = "ðŸ”‡ Ses KapalÄ±";
            btnToggleSound.style.backgroundColor = "#ff4757";
            if (!isMicMuted) setMicState(true);
        } else {
            btnToggleSound.innerText = "ðŸ”Š Ses Duyuluyor";
            btnToggleSound.style.backgroundColor = "#2ecc71";
        }
    });

    // --- WEBSOCKET ---
    function connectSocket(name) {
        socket = new WebSocket(WS_URL);

        socket.onopen = () => {
            statusDiv.innerText = "Odaya giriliyor...";
            socket.send(JSON.stringify({ type: 'join', name: name }));
        };

        socket.onmessage = (event) => {
            try {
                const data = JSON.parse(event.data);
                
                if (data.type === 'user-list') {
                    statusDiv.innerText = `Sohbet OdasÄ± (${data.users.length + 1} KiÅŸi)`;
                    data.users.forEach(user => {
                        userNames[user.id] = user.name;
                        createPeer(user.id, user.name, true);
                    });
                } 
                else if (data.type === 'user-joined') {
                    statusDiv.innerText = `${data.name} katÄ±ldÄ±.`;
                    userNames[data.id] = data.name;
                    updateNameUI(data.id, data.name);
                } 
                else if (data.type === 'signal') {
                    handleSignal(data.senderId, data.signal);
                }
                else if (data.type === 'user-left') {
                    removePeer(data.id);
                }
            } catch (e) { console.error(e); }
        };
        
        socket.onerror = () => statusDiv.innerText = "Sunucu BaÄŸlantÄ± HatasÄ±!";
    }

    // --- P2P ---
    function createPeer(targetId, name, initiator) {
        try {
            const peer = new window.SimplePeer({
                initiator: initiator,
                stream: localStream,
                trickle: false,
                config: {
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:global.stun.twilio.com:3478' }
                    ]
                }
            });

            peer.on('signal', signal => {
                socket.send(JSON.stringify({ type: 'signal', targetId: targetId, signal: signal }));
            });

            peer.on('stream', stream => {
                console.log("Ses Geldi:", targetId);
                addAudioElement(targetId, stream);
                const finalName = userNames[targetId] || name || "Bilinmeyen";
                addUserUI(targetId, finalName, true);
                attachVisualizer(stream, targetId);
            });

            peer.on('close', () => removePeer(targetId));
            peer.on('error', err => console.error("Peer hatasÄ±:", err));

            peers[targetId] = peer;
            if(!document.getElementById(`user-${targetId}`)) {
                const finalName = userNames[targetId] || name || "Bilinmeyen";
                addUserUI(targetId, finalName, false);
            }

        } catch (e) { console.error(e); }
    }

    function handleSignal(senderId, signal) {
        if (!peers[senderId]) {
            const storedName = userNames[senderId] || "Bilinmeyen";
            createPeer(senderId, storedName, false);
        }
        if (peers[senderId]) peers[senderId].signal(signal);
    }

    // --- UI YARDIMCILARI ---
    function addUserUI(id, name, isConnected) {
        let el = document.getElementById(`user-${id}`);
        const statusText = isConnected ? 'CanlÄ±' : 'BaÄŸlanÄ±yor...';
        const statusColor = isConnected ? '#e8f5e9' : '#fff3e0'; 

        if (!el) {
            el = document.createElement('div');
            el.id = `user-${id}`;
            el.className = 'user-card';
            userListDiv.appendChild(el);
        }
        
        el.style.backgroundColor = statusColor;
        el.innerHTML = `
            <div class="user-info">
                <span class="user-name">${name}</span>
                <span class="user-status">${statusText}</span>
            </div>
            <div class="meter-bg">
                <div id="meter-fill-${id}" class="meter-fill"></div>
            </div>
        `;
    }

    function updateNameUI(id, newName) {
        const el = document.getElementById(`user-${id}`);
        if (el) {
            const nameSpan = el.querySelector('.user-name');
            if (nameSpan) nameSpan.innerText = newName;
        }
    }

    function attachVisualizer(stream, id) {
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const source = audioCtx.createMediaStreamSource(stream);
        const analyser = audioCtx.createAnalyser();
        analyser.fftSize = 64; 
        source.connect(analyser);
        
        const dataArray = new Uint8Array(analyser.frequencyBinCount);
        const barElement = document.getElementById(`meter-fill-${id}`);

        function updateMeter() {
            if (!barElement) return; 
            analyser.getByteFrequencyData(dataArray);
            let sum = 0;
            for(let i = 0; i < dataArray.length; i++) sum += dataArray[i];
            const average = sum / dataArray.length;
            const percent = Math.min(100, average * 2.5); 
            barElement.style.width = percent + "%";
            requestAnimationFrame(updateMeter);
        }
        updateMeter();
    }

    function addAudioElement(id, stream) {
        if (document.getElementById(`audio-${id}`)) return;
        const audio = document.createElement('audio');
        audio.id = `audio-${id}`;
        audio.srcObject = stream;
        audio.autoplay = true;
        if (isDeafened) audio.muted = true;
        document.getElementById('audioContainer').appendChild(audio);
    }

    function removePeer(id) {
        if(peers[id]) { peers[id].destroy(); delete peers[id]; }
        const el = document.getElementById(`user-${id}`); if(el) el.remove();
        const aud = document.getElementById(`audio-${id}`); if(aud) aud.remove();
        delete userNames[id];
    }
</script>
</body>
</html>